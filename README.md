# Marketplace smart contracts
Smart contracts for Vemo Marketplace, powered by [LooksRare exchange v1](https://docs.looksrare.org/developers/welcome)

Avax Fuji
| Contract Type                         | Address                                   |
|---------------------------------------|-------------------------------------------|
| CurrencyManager | 0x84626a2E6E5a90E8e5bd44627EC356E820dFe298 |
| ExecutionManager | 0x5Ee975136c88A828583580F1AF0b6cfF1298690f |
| RoyaltyFeeRegistry | 0x4dbF72E3389481F5064112e6B7F2Bfb7ccC97732 |
| RoyaltyFeeManager | 0x3615B8E19644cdFA336eC8b976BE739e07E950B6 |
| Marketplace is |  0xBA5E72aEb72FC5B77CDBF5435519FC10f65054f6 |
| TransferManagerERC721 | 0x6BDfFaBAC48ad4EBF98803Bc64Ddc8E5c627b574 |
| TransferManagerERC1155 | 0x5f858B83E0BbF1DEc5817C3ccDb77DF8De6E228c |
| TransferManagerNonCompliantERC721 | 0x1e96319FbD0F602A14b836D10C4d56e1DcF1841f |
| TransferSelectorNFT | 0x1c61871d162A94B44797D3C08dE716999E8Aee33 |
| OrderValidator | 0xA236bD1c9696dfE5A555AdD13D619b9DBbF7BA20 |
| StrategyStandardSaleForFixedPriceVoucher | 0xeb421E2Cc3A3705322713b977E4d600C5e02104d |


Avax Mainnet
| Contract Type                         | Address                                   |
|---------------------------------------|-------------------------------------------|
| ProxyAdmin | 0xA3b964dB3f497fBeD3A687d362FEea33dD88eBa4 |
| WETH | 0xB31f66AA3C1e785363F0875A1B74E27b85FD66c7|
| VOUCHER_FACTORY | 0xbB740E17f3c177172CaAcCef2F472DB41b9b1d19|
| CurrencyManager | 0x878AAD75e7A1D336D1872c0A4C5562c7c06F0b90|
| ExecutionManager | 0x1201e0975213EeEA087Ee630492841C1aC0f0311|
| RoyaltyFeeRegistry | 0x11060AaDB929a6254D741961e0076FD26d3E20c4|
| RoyaltyFeeManager | 0xd93d971516F8E51AFfD38eF2bBee31fAbdEf2ef4|
| VemoMarketplace | 0x5E6E62b978CFD1c8b3E798aEF2622DF18e801A1d|
| TransferManagerERC721 | 0xe39fb784f8F441338a0215b0E597d9fF914dAdF8|
| TransferManagerERC1155 | 0xE71ad6D9E3Ac9C63BED65250aCd758e080e656A1| --> not verify
| TransferManagerNonCompliantERC721 | 0xfBD8812DDFB56B5C92Ba89E9E2BE72d362f774Bf|
| TransferSelectorNFT | 0x095b63f91C76cAa245ccb070c798EfCCd8919e23|
| OrderValidator | 0x8FDf772c6B7f606c52Dd55c03735784840857Af9|
| StrategyStandardSaleForFixedPriceVoucher | 0xbd8f46A1427c8146A565a22d05AaFf2aa00a0ded"|


BNB mainnet
| Contract Type                         | Address                                   |
|---------------------------------------|-------------------------------------------|
| WETH                                  | 0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c |
| MARKETPLACE                           | 0x0f38Dd0D6D67388aF2575736629c5F8a9D81C8aA |
| EXECUTION_MANAGER                     | 0x954149a56f084e8451401dceFd0242182EB9954c |
| ROYALTY_FEE_MANAGER                   | 0x0d9ed97aaD16FC7A748B749423384EA091260f44 |
| CurrencyManager                       | 0xe85e685c692f5242E0B4647895206518a3cdCCed |
| StrategyStandardSaleForFixedPrice     | 0x3A24DA07ae15393F6Bc15a84b296Bc55898a982A |

BNB mainnet v2 (current)
| Contract Type                         | Address                                   |
|---------------------------------------|-------------------------------------------|
|ProxyAdmin | 0x210358e7F20a19DD04D6a6FBF607246CCaf07D6B| 
|CurrencyManager|             "0x7F912790606D7914d6dA71B951896Eb09CbeB221"|
|ExecutionManager|             "0x5A44621838dd637b4386E1aA6d38695E02E62884"|
|RoyaltyFeeRegistry|             "0xfBD8812DDFB56B5C92Ba89E9E2BE72d362f774Bf"|
|RoyaltyFeeManager|             "0xE9f918f441A910bb4FCdFb09F1B75C3C43Ea9d57"|
|Marketplace|             "0xed13e8d502d612b811846524ea303ceece31ea83"|
|TransferManagerERC721|             "0x5aA4FDf226f43BfC28F10C1e2ad3A295303f6fB3"|
|TransferManagerERC1155|             "0x580e0E3Ec4954361EB297b2a77d577F65699D0E8"|
|TransferManagerNonCompliantERC721|             "0xf478dEbC6933c11D9D180E91d3e2C8bd622e49eE"|
|TransferSelectorNFT|             "0xE921Ed58acFD842E6D0B51e8f1d26D8DA7143854"|
|OrderValidator|             "0xb385ccaa8A80cf5c151915787c7ed6BA59dA87E4"|
|StrategyStandardSaleForFixedPriceVoucher|             "0x2Bdd93007aE01616Fd0D4B8C550DE83DF9B6801a"|

BNB testnet v1
| Contract Type                         | Address                                   |
|---------------------------------------|-------------------------------------------|
| WETH | 0x0dE8FCAE8421fc79B29adE9ffF97854a424Cad09 |
| VOUCHER_FACTORY | 0xD0901C6fE9FA1A8D56D2250Db272D65391117dfc |
| CurrencyManager |0xDee03828d53cEd8673b3Da42E58726E270879672 |
| ExecutionManager |0xE386449B15512A2ABc6E9e27Aba55CDFe0012eFa |
| RoyaltyFeeRegistry |0x4170f66135892da562174d249bb8b36FC3069aB7 |
| RoyaltyFeeManager |0x749cC834fE85d40088968F7980A4806638c81fFA |
| Marketplace | 0x27d47868433C467e9Fa0109F6E5086D15D8e06A5 |
| TransferManagerERC721 |0xb7411BcAFeFDc571B0ca7273D4152f938AF72354 |
| TransferManagerERC1155 |0x84E2a57c961BcAD46D5725e3B73B3879C813Bbb1 |
| TransferManagerNonCompliantERC721 |0x31095b3A27A4821c505E8B51822eE7d53b8f2432 |
| TransferSelectorNFT |0x026Db00E52d79a4c4b5CFc66bC9Ca78533a92B72 |
| OrderValidator |0xe3ca17bE926564eFcf3b62a245fC387f7eBAa537 |
| StrategyStandardSaleForFixedPriceVoucher | 0x22Fe90B9c380e84dD102D8D74C1913067D172e2B |

## Prerequisites
- [NodeJS v18.x](https://nodejs.org/en)
- [Hardhat v2.16.x](https://hardhat.org/)
- [Foundry latest](https://book.getfoundry.sh/getting-started/installation)
- [OpenZeppelin v4.x](https://docs.openzeppelin.com/contracts/4.x/)

## Setup
- Install dependencies
```bash
$ yarn
```

- Create .env file from template
```bash
$ cp .env.example .env
```

- Fulfill credentials and secrets to .env file

## Compile
- Compile smart contracts
```bash
$ npx hardhat clean
$ npx hardhat compile
```

## Testing
- Hardhat test
```bash
$ npm test
```

## Foundry
- Compile
```bash
$ forge build
```

- Test
```bash
$ forge test
```

## Deploy
- (Once) Add supported chain config to hardhat.config.ts
```typescript
const config: HardhatUserConfig = {
  networks: {
    bnb_testnet: {
      url: "https://data-seed-prebsc-1-s1.bnbchain.org:8545",
      chainId: 97,
      accounts: [privateKey1, privateKey2]
    },
    ...
  }
  ...
}
```

### Deploy managers
The deployment flow:
1. Deploy manager contracts that index from - to 0 to 2
2. deploy marketplace
3. deploy TRANSFER_NFT_SELECTOR manager (index 3 )
4. deploy order validator index 4
5. deploy voucher strategies + whitelist on market

- Deploy main
```bash
$ IMPLEMENTATION=3 \
npx hardhat run ./scripts/deploy-managers.ts --network bnb_mainnet \
--verifier-url 'https://api.routescan.io/v2/network/mainnet/evm/43114/etherscan' \
--etherscan-api-key "1VYRT81XHNBY8BC2X88N9ZF4XRBXUJDYKQ"
```

>   where IMPLEMENTATION is number kind, values corresponding
>   - 0: CURRENCY_MANAGER
>   - 1: EXECUTION_MANAGER
>   - 2: ROYALTY_FEE_MANAGER
>   - 3: TRANSFER_NFT_SELECTOR,
>   - 4: ORDER_VALIDATOR,
>   - 5: STRATEGY_STANDARD_FIXED_PRICE,
>   - 6: STRATEGY_STANDARD_FIXED_PRICE_VOUCHER,

### Deploy marketplace
```bash
$ CURRENCY_MANAGER="<address>" \
EXECUTION_MANAGER="<address>" \
ROYALTY_FEE_MANAGER="<address>" \
WETH="<address>" \
npx hardhat run scripts/deploy-marketplace.ts --network <chain-name>
```

> Managers address is retrieved from previous step.
> WETH addresses for chains are
> - [WBNB](https://testnet.bscscan.com/address/0xae13d989dac2f0debff460ac112a837c89baa7cd)
> - [WAVAX](https://testnet.snowtrace.io/address/0xd00ae08403b9bbb9124bb305c09058e32c39a48c)

### Deploy helper components
```bash
$ IMPLEMENTATION=<kind> \
MARKETPLACE=<address> \
npx hardhat run ./scripts/deploy-managers.ts --network <chain-name>
--rpc-url [NETWORK_RPC_URL]
--verifier-url 'https://api.routescan.io/v2/network/mainnet/evm/43114/etherscan'
--etherscan-api-key ""
```

>   where IMPLEMENTATION is number kind, values corresponding
>   - 3: TRANSFER_NFT_SELECTOR
>   - 4: ORDER_VALIDATOR
>   MARKETPLACE is contract address of marketplace, retrieved from previous step.

### Deploy execution strategy
```bash
$ IMPLEMENTATION=<kind> \
EXECUTION_MANAGER=<address> \
npx hardhat run ./scripts/deploy-managers.ts --network <chain-name>
```

>   where IMPLEMENTATION is number kind, values corresponding
>   - 5: STRATEGY_STANDARD_FIXED_PRICE
>   EXECUTION_MANAGER is contract address of execution manager, retrieved from previous step.


## Verify contract
- Obtain and fulfill Explorer API key to .env file
```bash
export BSCSCAN_API_KEY="<API_KEY>"
```

- Verify contract, please remember to pass corresponding constructor arguments
```bash
$ npx hardhat verify --network <chain-name> <contract-address>
```
or
```bash
$ forge verify-contract 0x2133DD7Ad181929F8a4D0f98EE6D97703008228f  --watch --chain 43113 contracts/VemoMarket.sol:VemoMarket  --etherscan-api-key "" --num-of-optimizations 200 --compiler-version 0.8.7 --constructor-args
```

## Upgrade contracts
TBD

## Troubleshoot
- Deploy failed due to chain congestion, the solution is need to wait for traffic reduce and redeploy


## License
Copyright belongs to VemoNFT - Ace Labs
